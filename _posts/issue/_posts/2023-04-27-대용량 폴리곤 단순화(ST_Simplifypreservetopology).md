---
layout: post
date: 2023-04-27 15:35:50+0900
title: 대용량 폴리곤 단순화(ST_Simplifypreservetopology)
categories: issue
tag: [spark, parquet, wkt]
---


- 제약사항
  - spark 2.4.4 이상 필요
  - sedona thirdparty 필요
  - parquet 파일 필요

```python
from angora.conf import load_conf

from pyspark import sql, SparkConf, SparkContext
from sedona.register import SedonaRegistrator
from sedona.utils import KryoSerializer, SedonaKryoRegistrator


df_option = {
    "header": str(True).lower(),
    "infer_schema": str(False).lower(),
    "ignore_leading_white_space": str(True).lower(),
    "ignore_trailing_white_space": str(True).lower(),
    "multiline": str(False).lower(),
    "sep": str(",").lower()
}

conf = load_conf()

spark_master = conf.spark.master

spark_conf = SparkConf().setMaster(spark_master)

pairs = conf["spark"]
for k, v in list(pairs.items()):
    spark_conf.set(k, v)

sc = SparkContext(conf=spark_conf)
sqlContext = sql.SparkSession(sc)

spark_conf.set("spark.serializer", KryoSerializer.getName)
spark_conf.set("spark.kryo.registrator", SedonaKryoRegistrator.getName)
SedonaRegistrator.registerAll(sqlContext)

df = sqlContext.read.format('parquet').options(**df_option).load(f"/DATA/angora/geom/addr_sido")
df = df.selectExpr('si_nm','sig_cd', 'geom_centroid', 'geom', 'ST_AsText(ST_Simplifypreservetopology(ST_GeomFromWKT(geom), 0.01)) as geom_simple')
df.show(1, False)
print(df.printSchema())

# centroid 생성 쿼리
#"ST_AsText(ST_centroid(ST_GeomFromWKT(geom))) as geom_centroid",

# simplify 생성 쿼리
#"ST_AsText(ST_Simplifypreservetopology(ST_GeomFromWKT(geom), 0.01)) as geom_simple", 'geom')

# parquet 파티셔닝 쿼리
#df.repartition(3).write.format("parquet").mode("overwrite").options(**df_option).save(f"/DATA/angora/geom/addr_sido_v2")

# 생성된 df show 구문
#df = sqlContext.read.format('parquet').options(**df_option).load(f"/home/ubuntu1/angora/geom/zip_no_v2")
#df.show()
```

## Read result parquet

```
|si_nm | sig_cd | geom_centroid | geom | geom_simple |
|광주광역시|24    |POINT(126.835434872964 35.1557281270703)|MULTIPOLYGON(((126.760289915277 35.258703977594,126.763452842372 35.2564570369861,126.763848101042 35.2540287143583,126.760626548761 35.2471502089323,126.754831695484 35.2419035879411,126.753849262193 35.2370867436093,126.755259657707 35.2343612378378,126.767436358449 35.2319659911731,126.770296794024 35.2328362059605,126.771858021317 35.2309510117596,126.77536337554 35.230574962246,126.781638149436 35.2247821557218,126.789535949068 35.2238946061766,126.795377464311 35.2197789350631,126.801164680856 35.2197421737786,126.804395945474 35.2213158123703,126.805390982151 35.2182749796531,126.815659974275 35.2247019720345,126.8178228506 35.2238522359884,126.819806394241 35.2261495638685,126.823943229776 35.2257810843588,126.825050536892 35.2318345089679,126.833264548015 35.2283806815598,126.838484617273 35.2298241926424,126.840083197862 35.2307344403436,126.840805957565 35.2343944228831,126.844886842454 35.2346307431095,126.844298669753 35.2369924777437,126.847272760791 35.2372289612363,126.848074418362 35.2357409307378,126.851573840746 35.2383055530803,126.859407083287 35.2400047285171,126.862544943939 35.2452386838343,126.869139342197 35.2461789541025,126.878340770038 35.2513072966367,126.879598557602 35.2515222039183,126.878627946423 35.2490935344451,126.879942728402 35.2477401686129,126.889622488593 35.246657748334,126.89140113951 35.2498796967539,126.900164676651 35.2538211362793,126.903432241537 35.2574190441909,126.909419285203 35.2584428177812,126.914661287148 35.2582016334233,126.921398078539 35.2532269427757,126.929359028008 35.2524535584009,126.933743410153 35.2469349544836,126.932284291454 35.2406523398882,126.942276907449 35.2361652907318,126.943530007158 35.2317394553789,126.947573484216 35.2307733693942,126.951840452811 35.22459112519,126.953848518456 35.2252594856524,126.949787339734 35.2222771918835,126.948901306539 35.2190805511708,126.95641427021 35.2071883509252,126.965536204873 35.2033595452156,126.966151888232 35.2008325725365,126.958624252812 35.1930886866074,126.968147155883 35.1811427317097,126.971695281072 35.1798372556335,126.972119980249 35.1849523903957,126.973973362453 35.1861330346298,126.978221886783 35.1862072936049,126.981989927477 35.1839250076681,126.985803594822 35.1886320145042,126.991111473244 35.1863906187723,126.99668034985 35.1890033290552,126.999968359294 35.1888160950582,127.013385360965 35.1803835243235,127.017249414514 35.174408806064,127.021417031514 35.1730380000409,127.022275225302 35.1713596443189,127.020872965283 35.1672573168251,127.016810665514 35.1653319610524,127.011358457755 35.166169094844,127.00999676069 35.1636790741998,127.011728467659 35.1613169686189,127.011120431044 35.1589297009138,127.007744030375 35.1559286913417,127.009665927742 35.1496224701138,127.007184098474 35.143872104416,127.009279879956 35.1417826689509,127.008680929873 35.1334959849684,127.011832082069 35.1278162135392,127.011300209248 35.1255572266453,127.004587540365 35.1217611730709,126.99868603911 35.1157555886337,126.999931305273 35.1140502052763,126.98845718782 35.1100942381746,126.988854595928 35.1072700604637,126.986351740795 35.105945331425,126.988755908443 35.1013283807891,126.987580734446 35.0995341107866,126.988950143657 35.0949875883682,126.979615053561 35.0918737441832,126.974034157516 35.0918620479333,126.962805873203 35.0872030186182,126.958600460905 35.0825880219573,126.959472941159 35.0791315931423,126.951882078718 35.0731566112134,126.942320917382 35.0724679937841,126.932296200337 35.0743923223372,126.932527838298 35.077807091805,126.926093067992 35.0823921956905,126.924669353059 35.0879958258804,126.92104853938 35.0914696444002,126.918015389072 35.0915219582139,126.910644813072 35.0886593401362,126.905807230363 35.0820482028309,126.895104824941 35.0807141388945,126.891976504251 35.0779452858206,126.885403372222 35.0815902697405,126.87167725064 35.0743378280495,126.864501019869 35.075633692406,126.861131045938 35.0789419355706,126.85560925013 35.0783595305127,126.853812852296 35.0742898104763,126.848436114403 35.072222254279,126.844136719106 35.0654415713552,126.836918685496 35.0662333736492,126.835965097688 35.063856829552,126.826527742036 35.0624714025042,126.82185927266 35.0599482174933,126.818583150622 35.0527691353251,126.811372199082 35.0532267655036,126.807435674953 35.050895428986,126.80357491011 35.0524211011359,126.801460864948 35.0581524407,126.7969381866 35.0590497930525,126.795227677574 35.0611221520735,126.79138605804 35.0604467202592,126.781587563124 35.0538445911052,126.774897494525 35.0526696636107,126.768339977189 35.0545564504188,126.767344047829 35.0563581108362,126.7684313171 35.0614127832651,126.765108775768 35.0643618549848,126.759633000742 35.0624514363396,126.756737765721 35.0582444155254,126.753176920826 35.0647560329712,126.754138452454 35.0668515568153,126.758248952001 35.0686410505135,126.768583202899 35.0686187915596,126.771346363549 35.0701833130294,126.770544314515 35.0726817842269,126.76480152495 35.0787546465618,126.765645728943 35.0827255252953,126.763311600341 35.0842710296453,126.761872349651 35.091033054693,126.754282009101 35.0916776505138,126.749076076653 35.101615135132,126.735494013032 35.1079470246871,126.73265603856 35.1128554278557,126.730672422942 35.1121376738128,126.731281696859 35.1081088311915,126.729338583991 35.1075218439071,126.719500295759 35.1084233974915,126.715852802648 35.1107386731129,126.708826520353 35.1094702940241,126.705404325807 35.1130143144253,126.701628970323 35.1123245228961,126.697530709635 35.1075871231322,126.693914050915 35.1090677769308,126.692193213176 35.108098109637,126.690177212619 35.1110806695738,126.684899848441 35.1120172250961,126.683217920104 35.1114118698754,126.68443688298 35.1076365530149,126.680468493721 35.1078507431852,126.676329203296 35.1048869217098,126.667471876708 35.1051245268374,126.669304962683 35.1120228272486,126.663388789856 35.1148009581639,126.657058896499 35.1132836553331,126.65519810551 35.1148553326374,126.654961239485 35.1178144521698,126.65192960247 35.1196504252259,126.651723417872 35.1246586836813,126.654951550043 35.1370140987767,126.652826463238 35.1409131113226,126.653316605315 35.1439599598571,126.647563550205 35.1440356869189,126.644702847768 35.1466116423449,126.650152526087 35.1476524245521,126.65350555953 35.1527806384585,126.65141745275 35.1548184351333,126.655336336198 35.1588784351271,126.653662110345 35.1612712275988,126.654222882732 35.1645517785898,126.65707900469 35.1666159852741,126.662648922211 35.1663993108999,126.664283642555 35.1684400710975,126.670429552209 35.169517507836,126.672067648187 35.1722955910881,126.670896933456 35.1748132178976,126.668466776105 35.1748871156579,126.666591230281 35.1770903893963,126.667234655066 35.1788990850934,126.662581341894 35.1804490019646,126.66368389718 35.1822187188626,126.66175993618 35.1847171047608,126.657919949586 35.1862853226819,126.653203933269 35.1925180273709,126.656246116796 35.1940985968154,126.659070887708 35.1922626651271,126.662123936287 35.1937608670194,126.663513084842 35.1924780779265,126.66811251239 35.1926419427642,126.669602561249 35.1944916810007,126.672530612679 35.1939211124356,126.674430469465 35.1909630883945,126.677150347287 35.1910286994341,126.67758324063 35.2025405908357,126.679977090607 35.2040401018119,126.681003150398 35.2083733469408,126.684542810952 35.2098421336485,126.687053976273 35.2151940555355,126.690428538421 35.2149993999864,126.697008646029 35.2092648626924,126.702556134027 35.2075644505347,126.710699881234 35.2122728002774,126.717694871531 35.2123896632419,126.72078082624 35.2187845588937,126.718477894799 35.2217986923921,126.719880070551 35.2267662357886,126.723285279581 35.2287188891688,126.725185635139 35.2342490222679,126.729090431954 35.2373010160494,126.729955376936 35.2435971150586,126.737238985603 35.2529213211472,126.741774516247 35.2508079775679,126.748392665921 35.2533323607661,126.750536882372 35.2564161618768,126.760289915277 35.258703977594)))|POLYGON ((126.760289915277 35.258703977594, 126.755259657707 35.2343612378378, 126.805390982151 35.2182749796531, 126.878340770038 35.2513072966367, 126.929359028008 35.2524535584009, 126.968147155883 35.1811427317097, 126.999968359294 35.1888160950582, 127.021417031514 35.1730380000409, 127.011300209248 35.1255572266453, 126.951882078718 35.0731566112134, 126.918015389072 35.0915219582139, 126.807435674953 35.050895428986, 126.756737765721 35.0582444155254, 126.770544314515 35.0726817842269, 126.73265603856 35.1128554278557, 126.667471876708 35.1051245268374, 126.644702847768 35.1466116423449, 126.672067648187 35.1722955910881, 126.653203933269 35.1925180273709, 126.677150347287 35.1910286994341, 126.687053976273 35.2151940555355, 126.717694871531 35.2123896632419, 126.737238985603 35.2529213211472, 126.760289915277 35.258703977594))|

root
 |-- si_nm: string (nullable = true)
 |-- sig_cd: string (nullable = true)
 |-- geom_centroid: string (nullable = true)
 |-- geom: string (nullable = true)
 |-- geom_simple: string (nullable = false)
```

| 단순화 전 |
|:--:| 
| ![Image Alt 텍스트]({{"/assets/img/issue/단순화 전.png"| relative_url}}) | 

| 단순화 후 |
|:--:| 
| ![Image Alt 텍스트]({{"/assets/img/issue/단순화 후.png"| relative_url}}) | 
